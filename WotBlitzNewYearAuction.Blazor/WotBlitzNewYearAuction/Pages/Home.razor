@page "/"
@inject HttpClient Http;
@inject LocalStorage LocalStorage;

<PageTitle>Auction WOT Blitz</PageTitle>

<h4><a href="https://eu.wotblitz.com/en/auction/#/" class="link-light">WOT Blitz Auction</a></h4>

@if(Auction != null && Auction.AuctionItems != null && Auction.AuctionItems.Length > 0) {
<table class="table table-striped table-hover table-sm align-middle">
    <thead>
        <tr>
            <th scope="col">Tank Info</th>
            <th scope="col">TankName</th>
            <th scope="col">Current price</th>
            <th scope="col">Available</th>
            <th scope="col">Next price</th>
            <th scope="col">Avaialbility period</th>
        </tr>
    </thead>
    <tbody>
    @foreach(var auctionItem in Auction.AuctionItems.Where(i => i.Available && i.CurrentCount > 0).OrderBy(i => i.AvailableBefore)) {
       <tr>
        <th><TankCard Vehicle=@auctionItem.Vehicle></TankCard></th>
        <th><b style="color: @CollectibleColor">@auctionItem.Vehicle?.Name</b></th>
        <th>
            <span style="color: @PremiumColor">@auctionItem.Price?.PriceValue </span>
            @PriceDrop(auctionItem.Price!.PriceValue, auctionItem.InitialPrice)
        </th>
        <th><span style="color: @AvailableColor(auctionItem.CurrentCount, auctionItem.InitialCount)">@auctionItem.CurrentCount</span> / @auctionItem.InitialCount (@AvailablePercent(auctionItem.CurrentCount, auctionItem.InitialCount)%)</th>
        <th><span style="color: @PremiumColor">@auctionItem.NextPrice?.PriceValue</span>@NextPriceDrop(auctionItem.NextPriceDropAt)</th>
        <th>@auctionItem.AvailableFrom.ToString("dd.MM.yy") - @auctionItem.AvailableBefore.ToString("dd.MM.yy")</th>
       </tr>
    }
    </tbody>
</table>
}

@code {
    public string PremiumColor => "#d4d481";
    public string CollectibleColor => "#64c8f5";

    public AuctionResponse? Auction { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // TODO: setup timer to call API
        var auction = await Http.GetAuctionData();
        if (auction?.AuctionItems != null)
        {
            var initialPrices = await LocalStorage.ReadInitialPrices();
            foreach(var auctionItem in auction.AuctionItems.Where(i => i.Available && i.CurrentCount > 0))
            {
                var priceFromLocalStorage = initialPrices.FirstOrDefault(p => p.VehicleId == auctionItem.Vehicle!.Id);
                if (priceFromLocalStorage == null)
                {
                    await LocalStorage.SetInitialPrice(new InitialPrices { VehicleId = auctionItem.Vehicle!.Id, InitialPrice = auctionItem.Price!.PriceValue});
                    auctionItem.InitialPrice = auctionItem.Price!.PriceValue;
                }
                else
                {
                    auctionItem.InitialPrice = priceFromLocalStorage.InitialPrice;
                }
            }
        }
        Auction = auction;

    }

    public int AvailablePercent(int current, int total) 
    {
        return Convert.ToInt32(100 * (Convert.ToDecimal(current) / Convert.ToDecimal(total)));
    }

    public string AvailableColor(int current, int total)
    {
        var percent = AvailablePercent(current, total);
        return percent < 10 ? "red" : "green";
    }

    public string? NextPriceDrop(DateTime? nextDropTime) {
        if (nextDropTime == null)
        {
            return null;
        }
        var timeToNextPrice = nextDropTime - DateTime.UtcNow;
        return $" in {timeToNextPrice?.ToString(@"hh\:mm") ?? string.Empty}";
    }

    public string? PriceDrop(int currentPrice, int initialPrice)
    {
        if (currentPrice == initialPrice)
        {
            return null;
        }
        int diff = initialPrice - currentPrice;
        int diffPercent = Convert.ToInt32(100 * (Convert.ToDecimal(diff) / Convert.ToDecimal(initialPrice)));
        return $" -{diff} ({diffPercent}%)";
    }

}